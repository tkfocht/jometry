<html>
    <head>
        <title>J!ometry: Daily Jeopardy Visualizations</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="css/site.css"></link>
        <link rel="stylesheet" href="css/game.css"></link>
        <script src="/js/d3/d3.v7.min.js"></script>
        <script src="/js/util/util.v1.js"></script>
        <script src="/js/graphs/full_game_scatter.js"></script>
        <script src="/js/graphs/by_round_scatter.js"></script>
    </head>
    <body>
        <h1><a href="index.html">J!ometry</a></h1>
        <div class="section">
            <h1><span id="season-id"></span> Game <span id="game-number"></span> Summary <span id="game-date"></span></h1>
            <div id="game-summary">
                <table>
                    <thead>
                        <tr>
                            <th>Contestant</th>
                            <th>J! Score on Buzz</th>
                            <th>DJ! Score on Buzz</th>
                            <th>Total Score on Buzz</th>
                            <th>DDs Found</th>
                            <th>DD Score</th>
                            <th>DJ! Final Score</th>
                            <th>FJ! Final Score</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h1>Correct on Buzz &rarr; Daily Doubles Found (difference from expected)</h1>
            <div class="graph-description">
                Number of correct answers in each round. Annotated with Daily Doubles found
                in each round, and the difference with expectation. Expectation is estimated
                by assuming each correct answer is worth an equal expected share of the Daily Doubles.
            </div>
            <div id="bar-correct-on-buzz"></div>
        </div>
        <div class="section">
            <h1>Attempt Distribution</h1>
            <div class="graph-description">
                All buzz attempts, by contestant and round. Correct responses are at the bottom, incorrect responses are lighter and
                in the middle, and attempts where the contestant was locked out are lightest and at the top.
            </div>
            <div id="bar-attempts"></div>
        </div>
        <div class="section">
            <h1>ATT vs BUZZ%</h1>
            <div class="graph-description">
                Number of attempts to buzz and percent of successful buzzes, over the whole game. This game's
                contestant performances are labeled. Other games by the same contestants are in the same color, but faded.
            </div>
            <div id="scatter-att-buzz-pct"></div>
        </div>
        <div class="section">
            <h1>ATT vs BUZZ% by Round</h1>
            <div class="graph-description">
                Number of attempts to buzz and percent of successful buzzes, over the whole game. Jeopardy! round
                is circles, connected to Double Jeopardy! round as squares. This game's
                contestant performances are labeled. Other games by the same contestants are in the same color, but faded.
            </div>
            <div id="scatter-att-buzz-pct-by-round"></div>
        </div>
        <div class="section">
            <h1>ATT vs $/ATT</h1>
            <div class="graph-description">
                Number of attempts to buzz and money earned on buzzes per attempt, over the whole game. This game's
                contestant performances are labeled. Other games by the same contestants are in the same color, but faded.
            </div>
            <div id="scatter-att-score-att"></div>
        </div>
        <div class="section">
            <h1>ATT vs $/ATT by Round</h1>
            <div class="graph-description">
                Number of attempts to buzz and money earned on buzzes per attempt, over the whole game. Jeopardy! round
                is circles, connected to Double Jeopardy! round as squares. This game's
                contestant performances are labeled. Other games by the same contestants are in the same color, but faded.
            </div>
            <div id="scatter-att-score-att-by-round"></div>
        </div>
        <div class="section">
            <h1>ATT vs $/BUZ</h1>
            <div class="graph-description">
                Number of attempts to buzz and money earned per buzz, over the whole game. This game's
                contestant performances are labeled. Other games by the same contestants are in the same color, but faded.
            </div>
            <div id="scatter-att-score-buzz"></div>
        </div>
        <div class="section">
            <h1>ATT vs $/BUZ by Round</h1>
            <div class="graph-description">
                Number of attempts to buzz and money earned per buzz, over the whole game. Jeopardy! round
                is circles, connected to Double Jeopardy! round as squares. This game's
                contestant performances are labeled. Other games by the same contestants are in the same color, but faded.
            </div>
            <div id="scatter-att-score-buzz-by-round"></div>
        </div>
        <div id="footer">
            <p>This site is not affiliated with Jeopardy!. Data is taken from their published <a href="https://www.jeopardy.com/jbuzz/news-events/jeopardy-daily-box-scores">box scores.</a></p>
        </div>
        <script type="text/javascript">
            var seasonId = new URLSearchParams(window.location.search).get('season');
            var highlightGame = new URLSearchParams(window.location.search).get('game_id');
            d3.select("#season-id")
                .data([seasonId])
                .text(d => d);
            d3.select("#game-number")
                .data([highlightGame])
                .text(d => d);
            d3.csv(csvUrlForSeason(seasonId)).then(function(data) {
                //Baseline for graphs
                var margin = {top: 20, right: 20, bottom: 50, left: 70},
                    width = 960 - margin.left - margin.right,
                    height = 500 - margin.top - margin.bottom;

                //Data transformations
                data.forEach(function(d) {
                    d['Date'] = csvDateParse(d['Date']);
                    d['J! Buzz %'] = 100.0 * d['J! Buzzes'] / d['J! Attempts'];
                    d['DJ! Buzz %'] = 100.0 * d['DJ! Buzzes'] / d['DJ! Attempts'];
                    d['Total Buzz %'] = 100.0 * d['Total Buzz'] / d['Total Attempt'];
                    d['highlightGame'] = d['Game Id'] == highlightGame;
                });
                console.log(data);
                var highlightGameData = d3.filter(data, d => d['highlightGame']);
                d3.select("#game-date")
                    .data([highlightGameData[0]])
                    .text(d => dateFormat(d['Date']));
                console.log(highlightGameData);
                var highlightGameContestants = d3.map(highlightGameData, d => d['Contestant']);
                data.forEach(function(d) {
                    d['highlightContestant'] = highlightGameContestants.includes(d['Contestant']);
                });

                //Graphics functions
                var color = d3.scaleOrdinal()
                    .domain(highlightGameContestants)
                    .range(['#0072B2','#E69F00','#009E73'])
                var highlightGameColorFunction = function(d) {
                    if (d['highlightGame'] || d['highlightContestant']) {
                        return color(d['Contestant']);
                    } else {
                        return "black";
                    }
                };
                var highlightGameOpacityFunction = function(d) {
                    if (d['highlightGame']) {
                        return 1.0;
                    } else if (d['highlightContestant']) {
                        return 0.5;
                    } else {
                        return 0.1;
                    }
                };
                var highlightGameLabelFunction = function(d) {
                    if (d['highlightGame']) {
                        return d['Contestant'];
                    }
                };

                //Summary table
                var summaryTr = d3.select("#game-summary table tbody")
                    .selectAll("tr")
                    .data(highlightGameData)
                    .enter()
                    .append("tr");
                summaryTr.selectAll("td")
                    .data(function(d,i) {
                        return [
                            d['Contestant'],
                            d['J! Score on Buzz'],
                            d['DJ! Score on Buzz'],
                            d['Total Score on Buzz'],
                            d['J! DDs found'] + " " + d['DJ! DDs found'],
                            d['DJ! End Score'] - d['Total Score on Buzz'],
                            d['DJ! End Score'],
                            d['FJ! End Score']
                        ];
                    })
                    .enter()
                    .append("td")
                    .html(function(d,i) {
                        if (i>0) return d;
                        return '<span style="color: ' + color(d) + '">&#9632;</span>&nbsp;' + d;
                    });

                //ATT vs $/ATT
                fullGameScatter(
                    '#scatter-att-score-att',
                    data,
                    'Total Attempt', [0, 60], 'ATT',
                    'Total Score/Attempt', [-200,800], '$/ATT',
                    highlightGameColorFunction, highlightGameOpacityFunction, highlightGameLabelFunction,
                    width, height, margin
                );

                //ATT vs $/ATT by Round
                byRoundScatter(
                    '#scatter-att-score-att-by-round',
                    data,
                    ['J! Attempts','DJ! Attempts'], [0, 30], 'ATT',
                    ['J! Score/Attempt','DJ! Score/Attempt'], [-400,1200], '$/ATT',
                    highlightGameColorFunction, highlightGameOpacityFunction, highlightGameLabelFunction,
                    width, height, margin
                );

                //ATT vs $/BUZ
                fullGameScatter(
                    '#scatter-att-score-buzz',
                    data,
                    'Total Attempt', [0, 60], 'ATT',
                    'Total Score/Buzz', [-300,1000], '$/BUZ',
                    highlightGameColorFunction, highlightGameOpacityFunction, highlightGameLabelFunction,
                    width, height, margin
                );

                //ATT vs $/BUZ by Round
                byRoundScatter(
                    '#scatter-att-score-buzz-by-round',
                    data,
                    ['J! Attempts','DJ! Attempts'], [0, 30], 'ATT',
                    ['J! Score/Buzz','DJ! Score/Buzz'], [-750,1500], '$/BUZ',
                    highlightGameColorFunction, highlightGameOpacityFunction, highlightGameLabelFunction,
                    width, height, margin
                );

                //ATT vs Buzz%
                fullGameScatter(
                    '#scatter-att-buzz-pct',
                    data,
                    'Total Attempt', [0, 60], 'ATT',
                    'Total Buzz %', [0, 100], 'BUZZ %',
                    highlightGameColorFunction, highlightGameOpacityFunction, highlightGameLabelFunction,
                    width, height, margin
                );

                //ATT vs Buzz% by round
                byRoundScatter(
                    '#scatter-att-buzz-pct-by-round',
                    data,
                    ['J! Attempts','DJ! Attempts'], [0, 30], 'ATT',
                    ['J! Buzz %','DJ! Buzz %'], [0, 100], 'BUZZ %',
                    highlightGameColorFunction, highlightGameOpacityFunction, highlightGameLabelFunction,
                    width, height, margin
                );

                //ATT vs Correct on Buzz by round
                byRoundScatter(
                    '#scatter-att-correct-by-round',
                    data,
                    ['J! Attempts','DJ! Attempts'], [0, 30], 'ATT',
                    ['J! Correct on Buzz','DJ! Correct on Buzz'], [0, 30], 'Correct on Buzz',
                    highlightGameColorFunction, highlightGameOpacityFunction, highlightGameLabelFunction,
                    width, height, margin
                );


                //J! Correct on Buzz
                svg = d3.select("#bar-correct-on-buzz").append("svg")
                                .attr("width", width + margin.left + margin.right)
                                .attr("height", height + margin.top + margin.bottom)
                            .append("g")
                            .attr("transform",
                                "translate(" + margin.left + "," + margin.top + ")");
                var x = d3.scaleBand()
                    .domain(['J!', 'DJ!'])
                    .range([0, width])
                    .padding([0.2]);
                var y = d3.scaleLinear().range([height, 0]);
                y.domain([0, 25]);
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).tickSize(0));
                svg.append("g")
                    .call(d3.axisLeft(y));
                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x",0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Correct");  

                var xSubgroup = d3.scaleBand()
                    .domain(highlightGameContestants)
                    .range([0, x.bandwidth()])
                    .padding([0.05]);

                var sum = (previousValue, currentValue) => previousValue + currentValue;
                var jCorrectSum = d3.map(highlightGameData, d => +d['J! Correct on Buzz']).reduce(sum, 0);
                var jDDExpectedPerCorrect = 1.0 / jCorrectSum;
                var jG = svg.append('g')
                    .attr("transform", function(d) { return "translate(" + x('J!') + ",0)"; });
                jG.selectAll('rect')
                    .data(highlightGameData)
                    .enter()
                    .append('rect')
                    .attr('x', function(d) { return xSubgroup(d['Contestant']); })
                    .attr('y', function(d) { return y(d['J! Correct on Buzz']); })
                    .attr("width", xSubgroup.bandwidth())
                    .attr("height", function(d) { return height - y(d['J! Correct on Buzz']); })
                    .attr("fill", highlightGameColorFunction);
                jG.selectAll('text')
                    .data(highlightGameData)
                    .enter()
                    .append('text')
                    .attr('x', function(d) { return xSubgroup(d['Contestant']) + 2; })
                    .attr('y', function(d) { return y(d['J! Correct on Buzz']) - 10; })
                    .style('fill', highlightGameColorFunction)
                    .html(d => d['J! Correct on Buzz'] + " &rarr; " + d['J! DDs found'] + " (" + 
                            ((+d['J! DDs found'] - (jDDExpectedPerCorrect * d['J! Correct on Buzz'])) > 0 ? "+" : "") +
                            (+d['J! DDs found'] - (jDDExpectedPerCorrect * d['J! Correct on Buzz'])).toFixed(2) + 
                            ")");

                var djCorrectSum = d3.map(highlightGameData, d => +d['DJ! Correct on Buzz']).reduce(sum, 0);
                var djDDExpectedPerCorrect = 2.0 / djCorrectSum;
                var djG = svg.append('g')
                    .attr("transform", function(d) { return "translate(" + x('DJ!') + ",0)"; });
                djG.selectAll('rect')
                    .data(highlightGameData)
                    .enter()
                    .append('rect')
                    .attr('x', function(d) { return xSubgroup(d['Contestant']); })
                    .attr('y', function(d) { return y(d['DJ! Correct on Buzz']); })
                    .attr("width", xSubgroup.bandwidth())
                    .attr("height", function(d) { return height - y(d['DJ! Correct on Buzz']); })
                    .attr("fill", highlightGameColorFunction);
                djG.selectAll('text')
                    .data(highlightGameData)
                    .enter()
                    .append('text')
                    .attr('x', function(d) { return xSubgroup(d['Contestant']) + 2; })
                    .attr('y', function(d) { return y(d['DJ! Correct on Buzz']) - 10; })
                    .style('fill', highlightGameColorFunction)
                    .html(d => d['DJ! Correct on Buzz'] + " &rarr; " + d['DJ! DDs found'] + " (" + 
                            ((+d['DJ! DDs found'] - (djDDExpectedPerCorrect * d['DJ! Correct on Buzz'])) > 0 ? "+" : "") +
                            (+d['DJ! DDs found'] - (djDDExpectedPerCorrect * d['DJ! Correct on Buzz'])).toFixed(2) + 
                            ")");               
                
                var legend = svg.append("g")
                    .attr("font-size", 13)
                    .attr("text-anchor", "end")
                    .selectAll("g")
                    .data(highlightGameContestants)
                    .enter().append("g")
                    .attr("transform", function(d, i) { return "translate(0," + i * 24 + ")"; });
                legend.append("rect")
                    .attr("x", width - 142)
                    .attr("width", 8)
                    .attr("height", 8)
                    .attr("fill", color);
                legend.append("text")
                        .attr("x", d => d.length > 7 ? (width + 5) : (width - 80))
                        .attr("y", 5.5)
                        .attr("dy", "0.22em")
                        .text(d => (d));

                //Attempt Distribution
                svg = d3.select("#bar-attempts").append("svg")
                                .attr("width", width + margin.left + margin.right)
                                .attr("height", height + margin.top + margin.bottom)
                            .append("g")
                            .attr("transform",
                                "translate(" + margin.left + "," + margin.top + ")");
                var x = d3.scaleBand()
                    .domain(['J!', 'DJ!'])
                    .range([0, width])
                    .padding([0.2]);
                var y = d3.scaleLinear().range([height, 0]);
                y.domain([0, 30]);
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).tickSize(0));
                svg.append("g")
                    .call(d3.axisLeft(y));
                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x",0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Correct");  

                var xSubgroup = d3.scaleBand()
                    .domain(highlightGameContestants)
                    .range([0, x.bandwidth()])
                    .padding([0.05]);

                var jG = svg.append('g')
                    .attr("transform", function(d) { return "translate(" + x('J!') + ",0)"; });
                var jGCorrectG = jG.append('g');
                var jGIncorrectG = jG.append('g');
                var jGLockedG = jG.append('g');
                jGCorrectG.selectAll('rect')
                    .data(highlightGameData)
                    .enter()
                    .append('rect')
                    .attr('x', function(d) { return xSubgroup(d['Contestant']); })
                    .attr('y', function(d) { return y(d['J! Correct on Buzz']); })
                    .attr("width", xSubgroup.bandwidth())
                    .attr("height", function(d) { return height - y(d['J! Correct on Buzz']); })
                    .attr("fill", highlightGameColorFunction);
                jGIncorrectG.selectAll('rect')
                    .data(highlightGameData)
                    .enter()
                    .append('rect')
                    .attr('x', function(d) { return xSubgroup(d['Contestant']); })
                    .attr('y', function(d) { return y(d['J! Buzzes']); })
                    .attr("width", xSubgroup.bandwidth())
                    .attr("height", function(d) { return height - y(d['J! Buzzes'] - d['J! Correct on Buzz']); })
                    .attr("fill", highlightGameColorFunction)
                    .attr("opacity", 0.7);
                jGLockedG.selectAll('rect')
                    .data(highlightGameData)
                    .enter()
                    .append('rect')
                    .attr('x', function(d) { return xSubgroup(d['Contestant']); })
                    .attr('y', function(d) { return y(d['J! Attempts']); })
                    .attr("width", xSubgroup.bandwidth())
                    .attr("height", function(d) { return height - y(d['J! Attempts'] - d['J! Buzzes']); })
                    .attr("fill", highlightGameColorFunction)
                    .attr("opacity", 0.3);

                var djG = svg.append('g')
                    .attr("transform", function(d) { return "translate(" + x('DJ!') + ",0)"; });
                var djGCorrectG = djG.append('g');
                var djGIncorrectG = djG.append('g');
                var djGLockedG = djG.append('g');
                djGCorrectG.selectAll('rect')
                    .data(highlightGameData)
                    .enter()
                    .append('rect')
                    .attr('x', function(d) { return xSubgroup(d['Contestant']); })
                    .attr('y', function(d) { return y(d['DJ! Correct on Buzz']); })
                    .attr("width", xSubgroup.bandwidth())
                    .attr("height", function(d) { return height - y(d['DJ! Correct on Buzz']); })
                    .attr("fill", highlightGameColorFunction);
                djGIncorrectG.selectAll('rect')
                    .data(highlightGameData)
                    .enter()
                    .append('rect')
                    .attr('x', function(d) { return xSubgroup(d['Contestant']); })
                    .attr('y', function(d) { return y(d['DJ! Buzzes']); })
                    .attr("width", xSubgroup.bandwidth())
                    .attr("height", function(d) { return height - y(d['DJ! Buzzes'] - d['DJ! Correct on Buzz']); })
                    .attr("fill", highlightGameColorFunction)
                    .attr("opacity", 0.7);
                djGLockedG.selectAll('rect')
                    .data(highlightGameData)
                    .enter()
                    .append('rect')
                    .attr('x', function(d) { return xSubgroup(d['Contestant']); })
                    .attr('y', function(d) { return y(d['DJ! Attempts']); })
                    .attr("width", xSubgroup.bandwidth())
                    .attr("height", function(d) { return height - y(d['DJ! Attempts'] - d['DJ! Buzzes']); })
                    .attr("fill", highlightGameColorFunction)
                    .attr("opacity", 0.3);

                var legend = svg.append("g")
                    .attr("font-size", 13)
                    .attr("text-anchor", "end")
                    .selectAll("g")
                    .data(highlightGameContestants)
                    .enter().append("g")
                    .attr("transform", function(d, i) { return "translate(0," + i * 24 + ")"; });
                legend.append("rect")
                    .attr("x", width - 142)
                    .attr("width", 8)
                    .attr("height", 8)
                    .attr("fill", color);
                legend.append("text")
                        .attr("x", d => d.length > 7 ? (width + 5) : (width - 80))
                        .attr("y", 5.5)
                        .attr("dy", "0.22em")
                        .text(d => (d));





            });
        </script>
    </body>
</html>